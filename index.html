<!doctype html>

<script src="http://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.js"></script>
<script src="mithril.js"></script>
<!--<script src="mithril_next.js"></script>-->
<script src="jquery.js"></script>
<script>

var fadeIn = function(e, isInit){
   if (!isInit) 
      $(e).delay(250).fadeIn(1000)
}

var items = [{id:0, name:'item 1', state: {in: ''}, color: 'DarkSeaGreen'}, {id:1, name:'item  2', state: {in: ''}, color: 'lightBlue'}, {id:2, name:'item3', state: {in: ''}, color: 'lightgrey'}]

function controller(){
    this.list = items
    this.showList = []
}
   
var add = function(){
   var item = _.sample(this.list)
   this.list = _.reject(this.list, function(v){
      return _.isEqual(v.id, item.id)
   })
   if (!_.isEmpty(item))
      this.showList.push(item)
}

var reset = function(){
   this.list = items
   this.showList = []
}

var isIn = function(i){
   return _.has(i.state, 'in')
}

var toggle = function(){
   if (isIn(this))
      _.assign(this, {state: {out: ''}})
   else
      _.assign(this, {state: {in: ''}})
}
   
var body = m('body', {style: {width:'600px', margin: '0 auto'}})

var header = function(ctrl){
    return m('header', 'Switch Boxes')
}

var btn = function(ctrl){
   return m('button', {onclick:add.bind(ctrl)}, 'click')
}
var resetButton = function(ctrl){
   return m('button', {onclick:reset.bind(ctrl)}, 'reset')
} 

var item = function(item){
    return m('div#id' + item.id, {style: {'background-color': item.color, width: '100px', height:'50px'}, config: fadeIn, onclick: toggle.bind(item)}, item.name + isIn(item))
}
var list = _.curry(function(inOut, ctrl){
    return m('.items',
             _(ctrl.showList)
             .tap(function(a){
                var b = a
             })
             .filter(function(i){
                return _.has(i.state, inOut)
             })
             .tap(function(a){
                var b = a
             })
             .sortBy('id')
             .tap(function(a){
                var b = a
             })
             .map(function(i){
                 return item(i)
             })
             .tap(function(a){
                var b = a
             })
             .value())
})

var listIn = list('in')
var listOut = list('out')

var main = function(ctrl){
   var result = [body, header(ctrl), btn(ctrl), resetButton(ctrl), listIn(ctrl), m('hr'), listOut(ctrl)]
   return result
}
m.module(document, {view:main, controller:controller})
</script>
